<section class="space-y-8 pb-12">
  <header class="flex flex-wrap items-center justify-between gap-4 px-2">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Company Prospectos</h1>
      <p class="text-gray-500 font-medium">{{ statusMessage() }}</p>
    </div>
    <div class="flex gap-3">
      <button
        class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-all shadow-sm"
        (click)="refresh()">
        <lucide-icon name="refresh-cw" class="size-4" [class.animate-spin]="loading()"></lucide-icon>
        Refrescar
      </button>
    </div>
  </header>

  <article class="glass-card">
    <div *ngIf="hasServerFilter()" class="server-filter-banner">
      <span>
        Filtrando por <strong>source_scraping</strong> = {{ sourceScrapingFilter() }}
      </span>
      <button type="button" class="text-sm font-semibold underline hover:text-hc-700"
        (click)="clearSourceScrapingFilter()">
        Ver todos
      </button>
    </div>

    <div class="table-controls mb-6">
      <div class="control-field grow">
        <label for="searchFilter">Criterio de búsqueda</label>
        <div class="relative">
          <input id="searchFilter" type="search" placeholder="Título, link, fuente..." [value]="searchTerm()"
            (input)="onSearchInput($event)" class="w-full pl-10" />
          <lucide-icon name="search"
            class="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-gray-400"></lucide-icon>
        </div>
      </div>
      <div class="control-field">
        <label for="companyFilter">Source_Scraping</label>
        <select id="companyFilter" [value]="companyFilter()" (change)="onCompanyFilterChange($event)">
          <option value="">Todas</option>
          <option *ngFor="let company of companyOptions()" [value]="company">
            {{ company }}
          </option>
        </select>
      </div>
      <div class="control-field">
        <label for="sourceFilter">Fuente</label>
        <select id="sourceFilter" [value]="sourceFilter()" (change)="onSourceFilterChange($event)">
          <option value="">Todas</option>
          <option *ngFor="let source of sourceOptions()" [value]="source">
            {{ source }}
          </option>
        </select>
      </div>
      <button type="button"
        class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 hover:text-hc-600 disabled:opacity-30 transition-colors"
        (click)="clearFilters()" [disabled]="!hasActiveFilters()">
        <lucide-icon name="x" class="size-4"></lucide-icon>
        Limpiar
      </button>
    </div>

    <p-table #resultsTable class="results-table" [value]="tableRows()" [loading]="loading()" [paginator]="true"
      [rows]="10" [rowsPerPageOptions]="[10, 20, 50]" [showCurrentPageReport]="true" [globalFilterFields]="[
        'companyLabel',
        'title',
        'link',
        'redirect_link',
        'displayed_link',
        'displaySource',
        'sourceScraping'
      ]" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}" responsiveLayout="scroll"
      dataKey="link_key">
      <ng-template pTemplate="header">
        <tr>
          <th>Source Scraping</th>
          <th>Resultado / Título</th>
          <th>Links</th>
          <th>Fuente</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-result>
        <tr>
          <td>
            <div class="flex flex-col gap-0.5">
              <span class="font-bold text-gray-900 leading-tight">
                {{ result.sourceScraping || 'Sin dato' }}
              </span>
              <span class="text-xs text-gray-400 font-mono">
                ID: {{ result.company_id }}
              </span>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1 max-w-sm">
              <span class="font-semibold text-gray-800 leading-tight line-clamp-2" title="{{ result.title }}">
                {{ result.title || 'Sin título' }}
              </span>
              <span class="text-xs text-gray-500 font-medium truncate" *ngIf="result.displayed_link">
                {{ result.displayed_link }}
              </span>
            </div>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <a *ngIf="result.link" [href]="result.link" target="_blank" rel="noopener"
                class="p-1.5 rounded-lg bg-gray-50 text-gray-500 hover:text-hc-600 hover:bg-hc-50 transition-colors"
                title="Link Original">
                <lucide-icon name="link" class="size-4"></lucide-icon>
              </a>
              <a *ngIf="result.redirect_link" [href]="result.redirect_link" target="_blank" rel="noopener"
                class="p-1.5 rounded-lg bg-gray-50 text-gray-500 hover:text-hc-600 hover:bg-hc-50 transition-colors"
                title="Link Redirección">
                <lucide-icon name="external-link" class="size-4"></lucide-icon>
              </a>
            </div>
          </td>
          <td>
            <span
              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700">
              {{ result.displaySource }}
            </span>
          </td>
          <td class="actions-column">
            <div class="flex items-center justify-end gap-1">
              <button class="icon-btn" (click)="startEdit(result)" title="Editar">
                <lucide-icon name="pencil" class="size-4"></lucide-icon>
              </button>
              <button class="icon-btn icon-btn--danger" (click)="deleteResult(result)" title="Eliminar">
                <lucide-icon name="trash" class="size-4"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </article>
</section>