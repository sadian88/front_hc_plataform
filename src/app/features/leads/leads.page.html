<section class="space-y-8 pb-12">
  <header class="flex flex-wrap items-center justify-between gap-4 px-2">
    <div>
      <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">User Interactions</h1>
      <p class="text-gray-500 font-medium">{{ statusMessage() }}</p>
    </div>
    <div class="flex gap-3">
      <button
        class="flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-5 py-2.5 text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-all shadow-sm"
        (click)="refresh()">
        <lucide-icon name="refresh-cw" class="size-4" [class.animate-spin]="loading()"></lucide-icon>
        Refrescar
      </button>
    </div>
  </header>

  <article class="glass-card">
    <div *ngIf="hasServerFilter()" class="server-filter-banner">
      <span>
        Filtrando por <strong>source_scraping</strong> = {{ sourceScrapingFilter() }}
      </span>
      <button type="button" class="btn-secondary" (click)="clearSourceScrapingFilter()">
        Ver todos
      </button>
    </div>

    <div class="table-controls mb-6">
      <div class="control-field grow">
        <label for="searchFilter">Criterio de búsqueda</label>
        <div class="relative">
          <input id="searchFilter" type="search" placeholder="Nombre, rol, tags..." [value]="searchTerm()"
            (input)="onSearchInput($event)" class="w-full pl-10" />
          <lucide-icon name="search"
            class="absolute left-3 top-1/2 -translate-y-1/2 size-4 text-gray-400"></lucide-icon>
        </div>
      </div>
      <div class="control-field">
        <label for="companyFilter">Compañía</label>
        <select id="companyFilter" [value]="companyFilter()" (change)="onCompanyFilterChange($event)">
          <option value="">Todas las compañías</option>
          <option *ngFor="let company of companyOptions()" [value]="company">
            {{ company }}
          </option>
        </select>
      </div>
      <div class="control-field">
        <label for="countryFilter">País / Región</label>
        <select id="countryFilter" [value]="countryFilter()" (change)="onCountryFilterChange($event)">
          <option value="">Cualquier ubicación</option>
          <option *ngFor="let country of countryOptions()" [value]="country">
            {{ country }}
          </option>
        </select>
      </div>
      <button type="button"
        class="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-gray-600 hover:text-hc-600 disabled:opacity-30 transition-colors"
        (click)="clearFilters()" [disabled]="!hasActiveFilters()">
        <lucide-icon name="x" class="size-4"></lucide-icon>
        Limpiar
      </button>
    </div>

    <p-table #leadTable class="lead-table" [value]="tableRows()" [loading]="loading()" [paginator]="true" [rows]="10"
      [rowsPerPageOptions]="[10, 20, 50]" [showCurrentPageReport]="true" [globalFilterFields]="[
        'nombre',
        'cargo',
        'sourceCompany',
        'sourceScraping',
        'prospectCompany',
        'displayCountry',
        'rol_funcional',
        'linkedin_url',
        'tags_internos'
      ]" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}" responsiveLayout="scroll"
      dataKey="id_lead">
      <ng-template pTemplate="header">
        <tr>
          <th>Usuario</th>
          <th>Empresa</th>
          <th>Cargo</th>
          <th>Ubicación</th>
          <th>Score</th>
          <th>Conversión</th>
          <th>Fecha</th>
          <th>Interacción</th>
          <th class="actions-column">ACCIONES</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-lead>
        <tr>
          <td>
            <div class="flex items-center gap-3">
              <div class="avatar-circle">
                <lucide-icon name="user" class="size-4"></lucide-icon>
              </div>
              <div class="flex flex-col">
                <span class="font-bold text-gray-900 leading-tight">{{ lead.nombre || 'N/A' }}</span>
                <div class="tag-list mt-1" *ngIf="lead.tags_internos?.length">
                  <span class="tag-pill" *ngFor="let tag of lead.tags_internos">{{ tag }}</span>
                </div>
              </div>
            </div>
          </td>
          <td>
            <div class="flex flex-col">
              <span class="font-semibold text-gray-700">{{ lead.prospectCompany || '---' }}</span>
              <span class="text-xs text-gray-400" *ngIf="lead.sector_empresa">{{ lead.sector_empresa }}</span>
            </div>
          </td>
          <td>
            <span class="text-sm text-gray-600 font-medium">{{ lead.cargo || '---' }}</span>
          </td>
          <td>
            <div class="flex items-center gap-2">
              <span class="text-xs font-bold text-gray-400 uppercase">{{ lead.pais ? lead.pais.substring(0,2) : 'GL'
                }}</span>
              <span class="text-sm text-gray-600">{{ lead.displayCountry || 'Global' }}</span>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-0.5">
              <div class="flex text-yellow-400">
                <lucide-icon name="star" class="size-3 fill-current" *ngFor="let i of [1,2,3,4]"></lucide-icon>
                <lucide-icon name="star" class="size-3 text-gray-200 fill-current"></lucide-icon>
              </div>
              <span class="text-[10px] font-bold text-gray-400">{{ lead.score }}/100</span>
            </div>
          </td>
          <td>
            <div [ngSwitch]="lead.conversionStatus">
              <span *ngSwitchCase="'si'" class="status-pill status-pill--si">
                <lucide-icon name="check" class="size-3"></lucide-icon> SI
              </span>
              <span *ngSwitchCase="'no'" class="status-pill status-pill--no">
                <lucide-icon name="x" class="size-3"></lucide-icon> NO
              </span>
              <span *ngSwitchDefault class="status-pill status-pill--pendiente">
                <lucide-icon name="clock" class="size-3"></lucide-icon> Pendiente
              </span>
            </div>
          </td>
          <td class="whitespace-nowrap">
            <span class="text-sm text-gray-600 font-medium">
              {{ lead.updated_at ? (lead.updated_at | date: 'dd MMM yyyy') : '---' }}
            </span>
          </td>
          <td>
            <div class="flex items-center gap-2 text-gray-500" [ngSwitch]="lead.interactionType">
              <ng-container *ngSwitchCase="'reaction'">
                <lucide-icon name="heart" class="size-4 text-pink-500 fill-pink-500"></lucide-icon>
                <span class="text-xs font-semibold">Reacción</span>
              </ng-container>
              <ng-container *ngSwitchCase="'comment'">
                <lucide-icon name="message-square" class="size-4 text-purple-500"></lucide-icon>
                <span class="text-xs font-semibold">Comentario</span>
              </ng-container>
              <ng-container *ngSwitchDefault>
                <lucide-icon name="eye" class="size-4 text-blue-500"></lucide-icon>
                <span class="text-xs font-semibold">Vista</span>
              </ng-container>
            </div>
          </td>
          <td class="actions-column">
            <div class="flex items-center justify-end gap-1">
              <button type="button" class="icon-btn" (click)="startEdit(lead)" title="Editar">
                <lucide-icon name="pencil" class="size-4"></lucide-icon>
              </button>
              <button type="button" class="icon-btn icon-btn--danger" (click)="deleteLead(lead)" title="Eliminar">
                <lucide-icon name="trash" class="size-4"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </article>
</section>