<section class="space-y-6">
  <header class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <p class="text-sm uppercase tracking-wide text-night-500">Resultados</p>
      <h1 class="text-3xl font-semibold text-night-100">Company_Prospectos</h1>
      <p class="text-night-400">{{ statusMessage() }}</p>
    </div>
    <button class="btn-secondary" type="button" (click)="refresh()">Refrescar lista</button>
  </header>

  <article class="glass-card card-primary space-y-4">
    <div *ngIf="hasServerFilter()" class="server-filter-banner">
      <span>
        Filtrando por <strong>source_scraping</strong> = {{ sourceScrapingFilter() }}
      </span>
      <button type="button" class="btn-secondary" (click)="clearSourceScrapingFilter()">
        Ver todos
      </button>
    </div>

    <div class="table-controls">
      <div class="control-field grow">
        <label for="searchFilter">Buscar</label>
        <input
          id="searchFilter"
          type="search"
          placeholder="Título, link, fuente..."
          [value]="searchTerm()"
          (input)="onSearchInput($event)" />
      </div>
      <div class="control-field">
        <label for="companyFilter">Source_Scraping</label>
        <select
          id="companyFilter"
          [value]="companyFilter()"
          (change)="onCompanyFilterChange($event)">
          <option value="">Todas</option>
          <option *ngFor="let company of companyOptions()" [value]="company">
            {{ company }}
          </option>
        </select>
      </div>
      <div class="control-field">
        <label for="sourceFilter">Fuente</label>
        <select
          id="sourceFilter"
          [value]="sourceFilter()"
          (change)="onSourceFilterChange($event)">
          <option value="">Todas</option>
          <option *ngFor="let source of sourceOptions()" [value]="source">
            {{ source }}
          </option>
        </select>
      </div>
      <button
        type="button"
        class="btn-secondary clear-filters"
        (click)="clearFilters()"
        [disabled]="!hasActiveFilters()">
        Limpiar filtros
      </button>
    </div>

    <p-table
      #resultsTable
      class="results-table"
      [value]="tableRows()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 20, 50]"
      [showCurrentPageReport]="true"
      [globalFilterFields]="[
        'companyLabel',
        'title',
        'link',
        'redirect_link',
        'displayed_link',
        'displaySource',
        'sourceScraping'
      ]"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
      responsiveLayout="scroll"
      dataKey="link_key">
      <ng-template pTemplate="header">
        <tr>
          <th>Source_Scraping</th>
          <th>Resultado</th>
          <th>Link</th>
          <th>Redirect</th>
          <th>Fuente</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-result>
        <tr>
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-night-100">
                {{ result.sourceScraping || 'Sin dato' }}
              </span>
              <small class="text-night-500">
                {{ result.companyLabel }} · ID #{{ result.company_id }}
              </small>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-night-100">{{ result.title || 'Sin título' }}</span>
              <small class="text-night-500" *ngIf="result.displayed_link">
                {{ result.displayed_link }}
              </small>
            </div>
          </td>
          <td>
            <a class="link" [href]="result.link" target="_blank" rel="noopener">
              {{ result.link }}
            </a>
          </td>
          <td>
            <a
              class="link"
              *ngIf="result.redirect_link"
              [href]="result.redirect_link"
              target="_blank"
              rel="noopener">
              {{ result.redirect_link }}
            </a>
            <span class="text-secondary" *ngIf="!result.redirect_link">Sin URL</span>
          </td>
          <td>
            <span>{{ result.displaySource }}</span>
          </td>
          <td class="actions-column">
            <button type="button" class="action-btn" (click)="startEdit(result)">Editar</button>
            <button
              type="button"
              class="action-btn action-btn--danger"
              (click)="deleteResult(result)">
              Eliminar
            </button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </article>
</section>
