<section class="space-y-6">
  <header class="flex flex-wrap items-center justify-between gap-4">
    <div>
      <p class="text-sm uppercase tracking-wide text-night-500">Seguimiento</p>
      <h1 class="text-3xl font-semibold text-night-100">Lead Prospecto</h1>
      <p class="text-night-400">{{ statusMessage() }}</p>
    </div>
    <button class="btn-secondary" type="button" (click)="refresh()">Refrescar lista</button>
  </header>

  <article class="glass-card card-primary space-y-4">
    <div *ngIf="hasServerFilter()" class="server-filter-banner">
      <span>
        Filtrando por <strong>company_id</strong> = {{ sourceScrapingFilter() }}
      </span>
      <button type="button" class="btn-secondary" (click)="clearSourceScrapingFilter()">
        Ver todos
      </button>
    </div>

    <div class="table-controls">
      <div class="control-field grow">
        <label for="searchFilter">Buscar</label>
        <input
          id="searchFilter"
          type="search"
          placeholder="Nombre, email, empresa..."
          [value]="searchTerm()"
          (input)="onSearchInput($event)" />
      </div>
      <div class="control-field">
        <label for="companyFilter">Empresa asignada</label>
        <select
          id="companyFilter"
          [value]="companyFilter()"
          (change)="onCompanyFilterChange($event)">
          <option value="">Todas</option>
          <option *ngFor="let company of companyOptions()" [value]="company">
            {{ company }}
          </option>
        </select>
      </div>
      <div class="control-field">
        <label for="estadoFilter">Estado</label>
        <select
          id="estadoFilter"
          [value]="estadoFilter()"
          (change)="onEstadoFilterChange($event)">
          <option value="">Todos</option>
          <option *ngFor="let estado of estadoOptions()" [value]="estado">
            {{ estado }}
          </option>
        </select>
      </div>
      <button
        type="button"
        class="btn-secondary clear-filters"
        (click)="clearFilters()"
        [disabled]="!hasActiveFilters()">
        Limpiar filtros
      </button>
    </div>

    <p-table
      #prospectsTable
      class="prospect-table"
      [value]="tableRows()"
      [loading]="loading()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[10, 20, 50]"
      [showCurrentPageReport]="true"
      [globalFilterFields]="[
        'nombre_completo',
        'email',
        'perfil_linkedin',
        'cargo',
        'assignedCompanyLabel',
        'originCompanyLabel',
        'displayEstado',
        'displayLocation'
      ]"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords}"
      responsiveLayout="scroll"
      dataKey="id">
      <ng-template pTemplate="header">
        <tr>
          <th>Actualización</th>
          <th>Lead Prospecto</th>
          <th>Contacto</th>
          <th>Ubicación</th>
          <th>Empresas</th>
          <th class="actions-column">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-prospect>
        <tr>
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-night-100">
                {{ prospect.updated_at ? (prospect.updated_at | date: 'mediumDate') : 'Sin datos' }}
              </span>
              <small class="text-night-500" *ngIf="prospect.updated_at">
                {{ prospect.updated_at | date: 'shortTime' }}
              </small>
              <small class="text-night-400" *ngIf="prospect.fecha_creacion_origen">
                Origen: {{ prospect.fecha_creacion_origen | date: 'medium' }}
              </small>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <span class="font-semibold text-night-100">
                {{ prospect.nombre_completo || 'Sin nombre' }}
              </span>
              <span class="text-secondary" *ngIf="prospect.cargo">{{ prospect.cargo }}</span>
              <small class="text-night-500" *ngIf="prospect.about">{{ prospect.about }}</small>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <a
                *ngIf="prospect.email"
                class="link"
                [href]="'mailto:' + prospect.email">
                {{ prospect.email }}
              </a>
              <span class="text-night-500" *ngIf="!prospect.email">Sin email</span>
              <a
                class="link"
                *ngIf="prospect.perfil_linkedin"
                [href]="prospect.perfil_linkedin"
                target="_blank"
                rel="noopener">
                Perfil LinkedIn
              </a>
              <span class="text-night-400" *ngIf="!prospect.perfil_linkedin">Sin LinkedIn</span>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <span>{{ prospect.displayLocation }}</span>
              <small class="text-night-500">{{ prospect.displayEstado }}</small>
            </div>
          </td>
          <td>
            <div class="flex flex-col gap-1">
              <span>{{ prospect.assignedCompanyLabel || 'Sin asignar' }}</span>
              <small class="text-night-500">
                Origen: {{ prospect.originCompanyLabel || 'Sin registrar' }}
              </small>
            </div>
          </td>
          <td class="actions-column">
            <button type="button" class="action-btn" (click)="startEdit(prospect)">Editar</button>
            <button
              type="button"
              class="action-btn action-btn--danger"
              (click)="deleteProspect(prospect)">
              Eliminar
            </button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </article>
</section>

<article *ngIf="showForm()" class="glass-card card-secondary form-panel">
  <div class="form-panel__header">
    <h2 class="text-xl font-semibold text-night-100">Editar Lead Prospecto</h2>
    <button class="btn-secondary" type="button" (click)="resetForm()">Cerrar</button>
  </div>

  <div class="id-externo" *ngIf="selectedIdExterno()">
    <span class="label">ID externo:</span>
    <span class="value">{{ selectedIdExterno() }}</span>
  </div>

  <form class="prospect-form" [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="form-grid">
      <div class="form-control">
        <label for="nombreCompleto">Nombre completo</label>
        <div class="input-wrapper">
          <input
            id="nombreCompleto"
            type="text"
            placeholder="Nombre Apellido"
            formControlName="nombreCompleto" />
        </div>
      </div>

      <div class="form-control">
        <label for="cargo">Cargo</label>
        <div class="input-wrapper">
          <input id="cargo" type="text" placeholder="VP Sales" formControlName="cargo" />
        </div>
      </div>

      <div class="form-control">
        <label for="email">Email</label>
        <div class="input-wrapper">
          <input
            id="email"
            type="email"
            placeholder="persona@empresa.com"
            formControlName="email" />
        </div>
      </div>

      <div class="form-control">
        <label for="perfilLinkedin">LinkedIn</label>
        <div class="input-wrapper">
          <input
            id="perfilLinkedin"
            type="url"
            placeholder="https://linkedin.com/in/prospect"
            formControlName="perfilLinkedin" />
        </div>
      </div>

      <div class="form-control">
        <label for="location">Ubicación</label>
        <div class="input-wrapper">
          <input
            id="location"
            type="text"
            placeholder="Bogotá, Colombia"
            formControlName="location" />
        </div>
      </div>

      <div class="form-control">
        <label for="estado">Estado</label>
        <div class="input-wrapper">
          <input id="estado" type="text" placeholder="Activo" formControlName="estado" />
        </div>
      </div>

      <div class="form-control">
        <label for="fechaCreacionOrigen">Fecha creación origen</label>
        <div class="input-wrapper">
          <input
            id="fechaCreacionOrigen"
            type="datetime-local"
            formControlName="fechaCreacionOrigen" />
        </div>
      </div>

      <div class="form-control">
        <label for="companyId">ID compañía asignada</label>
        <div class="input-wrapper">
          <input
            id="companyId"
            type="number"
            placeholder="12"
            formControlName="companyId" />
        </div>
      </div>

      <div class="form-control">
        <label for="companyOrigenLead">ID compañía origen</label>
        <div class="input-wrapper">
          <input
            id="companyOrigenLead"
            type="text"
            placeholder="45"
            formControlName="companyOrigenLead" />
        </div>
      </div>
    </div>

    <div class="form-control textarea">
      <label for="about">Resumen</label>
      <div class="input-wrapper textarea">
        <textarea
          id="about"
          rows="3"
          placeholder="Notas relevantes del prospecto"
          formControlName="about"></textarea>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-primary">Guardar cambios</button>
      <button type="button" class="btn-secondary" (click)="resetForm()">Cancelar</button>
    </div>
  </form>
</article>
